\documentclass[11pt,a4paper,parskip=half]{scrartcl}
\usepackage{isabelle,isabellesym}

% further packages required for unusual symbols (see also
% isabellesym.sty), use only when needed

%\usepackage{amssymb}
  %for \<leadsto>, \<box>, \<diamond>, \<sqsupset>, \<mho>, \<Join>,
  %\<lhd>, \<lesssim>, \<greatersim>, \<lessapprox>, \<greaterapprox>,
  %\<triangleq>, \<yen>, \<lozenge>

%\usepackage[greek,english]{babel}
  %option greek for \<euro>
  %option english (default language) for \<guillemotleft>, \<guillemotright>

\usepackage[only,bigsqcap]{stmaryrd}
  %for \<Sqinter>

%\usepackage{eufrak}
  %for \<AA> ... \<ZZ>, \<aa> ... \<zz> (also included in amssymb)

%\usepackagetcomp}
  %for \<onequarter>, \<onehalf>, \<threequarters>, \<degree>, \<cent>,
  %\<currency>

% this should be the last package used
\usepackage{pdfsetup}

% urls in roman style, theoryt in math-similar italics
\urlstyle{rm}
\isabellestyle{it}

% for uniform font size
%\renewcommand{\isastyle}{\isastyleminor}

% From src/HOL/HOLCF/document/root
\newcommand{\isasymnotsqsubseteq}{\isamath{\not\sqsubseteq}}

\usepackage{amsmath}
\usepackage{graphicx}


\begin{document}

\title{The Correctness of Launchbury's Natural Semantics for Lazy Evaluation}
\author{Joachim Breitner\\
Programming Paradigms Group\\
Karlsruhe Institute for Technology}
\maketitle

\begin{abstract}
In his seminal paper „Natural Semantics for Lazy Evaluation“ \cite{launchbury},
John Launchbury proves his semantics correct with respect to a denotational
semantics. We have formalized both semantics and identified an ambiguity in
what the $\sqcup$ operator should do: If it is understood as the least upper
bound, as hinted at in the paper, the original proof fails.  We fix the proof
by taking a detour via a modified natural semantics with an explicit stack. In
addition, we show that the original proof goes through when $\sqcup$ is
understood to be a right-sided update.
\end{abstract}

\tableofcontents

\section{Introduction}

The Natural Semantics for Lazy Evaluation \cite{launchbury} created by John Launchbury in 1992 is often taken as the base for formal treatments of call-by-need evaluation, either to prove properties of lazy evaluation or as a base to describe extensions of the language or the implementation of the language (TODO: many citations). Therefore, assuarance about the correctness and adequacy of the semantics is important in this field of research. Launchbury himself supports his semantics by defining a standard denotational semantics. With regard to that, he then proves his his natural semantics both correct and adequate.

Although his proves are already on the more rigorous side for pen-and-paper-proofs, they have not yet been verified by transforming them to machine-checked proofs. This work is a first step, formalizing both semantics in the proof assistant Isabelle. In fact, we find a flaw in the proof: Launchbury uses the operator $\sqcup$ in the natural semantics, without giving a precise definition. If $\sqcup$ is understood to be the least upper bounds, then the generalisation of the correctness statement used in Launchbury's inductive proof is wrong, as shown in \ref{sec_Correctness-Counterexample}.

To avoid the problem, we define an alternative natural semantics in \ref{sec_LaunchburyStacked} that carries more information in the individual judgements. The added fields can be understood as the evaluation stack, carrying update frames and suspended application, hence the name. This semantics is equivalent to the original one (\ref{sec_Launchbury-Unstack}) and provably correct (\ref{sec_CorrectnessStacked}). It is worth noting that the correctness theorem did not require a generalisation in preperation of the inductive proof. This may indicate that the stacked semantics is more suitable for some proofs than the original one.

Another approach to avoid the problem is to understand $\sqcup$, which operates on environments, to be a right-sided update:
\[
(\rho \sqcup \rho')(x) = 
\begin{cases}
\rho'(x), &\text{if } x \in \operatorname{dom} \rho' \\
\rho(x), &\text{otherwise.}
\end{cases}
\]
With this definition, the original proof goes through as written in \cite{launchbury}. We doubt that this is reading is obviuos or intended, especially as the statement $\forall x. \rho(x) \sqsubseteq (\{\!\!\{\Gamma\}\!\!\})(x)$, given in \cite{launchbury} before the proof is only true when $\sqcup$ is understood to be the least upper bound.

Our contributions are:
 
\begin{itemize}
\item We define both semantics given by Launchbury in the theorem prover Isabelle.
\item In doing so we are the first to use both the Nominal package (to handle name binding) and the HOLCF package (for the domain-theoretic aspects) in the same development.
\item We identify a problem in the original correctness proof, and find two ways to fix it:
\begin{enumerate}
\item We define an alternative natural semantics with an explicit evaluation stack that simplifies the induction in the correctness proof and avoids the problem.
\item We show that the original proof goes through with a slight modification to the definition of the $\sqcup$-operator in the denotational semantics.
\end{enumerate}
\end{itemize}


\begin{figure}
\begin{center}
  \includegraphics[width=\textwidth]{session_graph}
\end{center}
\caption{Theory Dependency Graph\label{theory-deps}}
\end{figure}

\subsection{Theory overview}

Chapter \ref{ch_aux} contains auxillary theories, not necessarily tied to Launchbury's semantics. The base theories are kept independent of Nominal and HOLCF where possible, the lemmas combining them are in theories of their own, creatively named by appending \isa{-Nominal}, \isa{-HOLCF} or both.  You will find the section:
\begin{itemize}
\item General utility functions extending HOLCF resp.\ Nominal (\isa{Nominal-Utils}, \isa{HOLCF-Utils}).
\item A theory combining notions from HOLCF and Nominal, e.g. continutiy of permutation (\isa{Nominal-Utils}).
\item A notion of distinctly named associative lists (\isa{DistinctVars}, \isa{DistinctVars-Nominal}). 
\item A generalisation of some parts of HOLCF to work on a set as a carrier instead of a type (\isa{HOLCF-Set}).
\item Binary joins in the context of HOLCF (\isa{HOLCF-Join}).
\item A notion of down-closed sets in the context of HOLCF (\isa{HOLCF-Down-Closed}).
\item A theory of fixed points of binary joins (\isa{HOLCF-Fix-Join}).
\item A type for finite maps with a chain-complete partial order (\isa{FMap}, \isa{FMap-Nominal}, \isa{FMap-HOLCF}, \isa{FMap-Nominal-HOLCF}).
\end{itemize}

Chapter \ref{ch_natsem} defines Launchbury's natural semantics, while \ref{ch_natsemstack} provides a variant with an explicit stack and proves them equivalent.

Chapter \ref{ch_dendom} sets the stage for the denotational semantics by defining the denotational domain, proving that binary meets exist.

Chapter \ref{ch_denjoin} defines the denotational semantics where $\sqcup$ means the least upper bound. We show that Launchbury's Theorem 2 as stated is false for this semantics, and provide an alternative proof, that avoids the problematic generalisation, via the stacked semantics. The theory HSem is abstract in the concrete denotation of expressions.

Chapter \ref{ch_denupd} defines the denotational semantics where $\sqcup$ means right-sided update, and proves Launchbury's semantics correct using the proof from his paper. Again, the theory \isa{HSem} is abstract in the dconcrete enotation of expressions.

\subsection{Reusable components}

Parts of this theory are independent of the actual semantics and may be of use to other users of Isabelle:

The theory \isa{FMap} defines maps with an explicit and finite domain. The need for this arises due to the combination of Nominal and HOLCF:

To effectively use Nominal datat types need to be in the \isa{fs} type class, indicating that they have finite support. Only then can the \isa{nominal-induct} method avoid the variables occurring in the support of a value when choosing bound names in the inductive step, a crucial feature. Therefore, the usual data type for maps, \isa{var \isasymrightharpoonup value}, is insufficient. The obvious fix is to introduce a new type, \isa{(var, value) fmap} that contains only those maps with finite support.

But this causes issues with HOLCF: In order to work effectively with fixed points in HOLCF, the partial order for the type ought to have least upper bounds to all countable chains. With the usual order on partial maps, where binding additional variables makes the map larger, this is not possible in our type: Clearly the limit of a chain where at each step a new variable is added cannot have finite support.

Hence the partial order is changed so that only maps with the same domain are compareable. Assuing the values form a chain-complete partial order, we now have a chain-complete partial order on finite maps. Unfortunately, we now no longer have a bottom element for the whole type. In fact, the type is now the disjoint union of many pointed chain-complete partial orders. This makes proofs with fixed points relatively unwieldy, as we have to handle the domains of the maps explicitly. The theory \isa{HOLCF-Set} definines the notion of a set forming a pcpo and provides variants of some HOLCF function to work with an explicit carrier set instead of the whole universe of the type.

The theory \isa{HOLCF-Join} defines the binary join operator $\sqcup$ in a partial order as defined by HOLCF, together with the \isa{compatible} predicate, expressing that the least upper bound exists for its arguments.

\subsection{Acknowledgement}

I’d like to thank Andreas Lochbihler for his gladly given and usually very effective help during the development of this theory. This work was supported by the Deutsche Telekom Stiftung.

\clearpage
\newcommand{\theory}[1]{\subsection{#1}\label{sec_#1}\input{#1.tex}}

\section{Auxillary theories}

\label{ch_aux}

\theory{Nominal-Utils}

\theory{HOLCF-Utils}

\theory{Nominal-HOLCF}

\theory{DistinctVars}

\theory{DistinctVars-Nominal}

\theory{HOLCF-Set}

\theory{HOLCF-Join}

\theory{HOLCF-Down-Closed}

\theory{HOLCF-Fix-Join}

\theory{FMap}

\theory{FMap-Nominal}

\theory{FMap-HOLCF}

\theory{FMap-Nominal-HOLCF}


\clearpage
\section{Launchbury's natural semantics}
\label{ch_natsem}

\theory{Terms}
\theory{Heap}

\theory{Launchbury}

\clearpage
\section{Stackful natural semantics}
\label{ch_natsemstack}

\theory{LaunchburyStacked}

\theory{LaunchburyMoreFree}

\theory{Launchbury-Unstack}

\section{Denotational domain}
\label{ch_dendom}

\theory{Denotational-Common}

\theory{Value-Meet}

\theory{HeapToEnv}

\clearpage
\section{Denotational semantics with join}
\label{ch_denjoin}

\theory{HSem}

\theory{Denotational}

\theory{Denotational-Props}

\theory{Correctness-Counterexample}

\theory{CorrectnessStacked}

\theory{Correctness}

\clearpage
\section{Denotational semantics with update}
\label{ch_denupd}

\theory{HSemUpd}

\theory{DenotationalUpd}

\theory{Denotational-PropsUpd}

\theory{CorrectnessUpd}

%\clearpage
%\section{Conclusion}
%
%TODO

\clearpage
\bibliographystyle{abbrv}
\bibliography{root}

\end{document}
